# Managed by Guardian installer
# Generated from templates/ufw-rules.v4.j2
# IPv4 UFW ruleset

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow established sessions and loopback
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A INPUT -i lo -j ACCEPT

# Allow Docker bridge traffic
-A INPUT -i docker0 -j ACCEPT
-A OUTPUT -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT

# Permit management and web services from trusted LAN and VPN
{% set local_sources = [trusted_lan, wg_vpn_subnet] %}
{% set service_ports = [nextcloud_http_port, pihole_web_port, plex_port, netdata_port, immich_port] %}
{% for src in local_sources %}
-A INPUT -p tcp --dport {{ ssh_port }} -s {{ src }} -j ACCEPT
-A INPUT -p tcp --dport 80 -s {{ src }} -j ACCEPT
{% for port in service_ports %}
-A INPUT -p tcp --dport {{ port }} -s {{ src }} -j ACCEPT
{% endfor %}
# DNS for local networks and VPN
-A INPUT -p tcp --dport 53 -s {{ src }} -j ACCEPT
-A INPUT -p udp --dport 53 -s {{ src }} -j ACCEPT
{% endfor %}

# KVM lab network may only reach VPN
-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -i virbr50 -d {{ wg_vpn_subnet }} -j ACCEPT
-A FORWARD -i virbr50 -j DROP

# Explicitly drop any other inbound traffic (WAN)
-A INPUT -j DROP

COMMIT
